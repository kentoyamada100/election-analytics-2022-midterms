---
title: "01-Introduction"
author: "Kento Yamada"
date: "2022-09-15"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE)
knitr::opts_knit$set(root.dir = '/Users/kentoyamada/Documents/R-Projects/election-analytics-2022-midterms')
```

```{r pull functions, include = FALSE}
setwd("R")
files.sources = list.files()
sapply(files.sources, source)
setwd("..")
```

```{r load packages, include = FALSE}
library(tidyverse)
library(sf)
library(usmap)
library(usmapdata)
library(rmapshaper)
library(tigris)
library(plotly)
```

## Vote Share Margin by State: 2018
```{r load vote share data, include = FALSE}
vote_share <- read_csv("analysis_data/house_party_vote_share_by_district_1948-2020.csv")
```

```{r 2018 two-party vote share margin by state, include = FALSE}
vote_share_2018 <- vote_share %>%
  filter(raceYear == 2018) %>%
  group_by(State) %>%
  summarize(total_R = sum(RepVotes), total_D = sum(DemVotes)) %>%
  
  # Calculate two-party vote share in each state
  mutate(vote_share_R = 100 * total_R / (total_R + total_D),
         vote_share_D = 100 * total_D / (total_R + total_D)) %>%
  
  # Calculate vote margin
  mutate(margin_R = vote_share_R - vote_share_D)  %>%
  
  # rename: State -> state
  rename(state = State)
```

```{r 2018 vote share margin map, include = FALSE}
plot_vote_share_margin_2018 <- 
  plot_usmap(data = vote_share_2018, regions = "states", values = "margin_R") +
  
  # Change color based on vote share margin
  scale_fill_gradient2(
    high = "red",
    mid = "white",
    low = "blue",
    name = "Vote Share \nMargin (%)"
  ) +

  labs(title = "Vote Share Margin by State",
       subtitle = "2018 House of Representatives Elections") +
  
  # Set theme
  theme(legend.position = "right",
        plot.title = element_text(size = 12),
        plot.subtitle = element_text(size = 10),
        legend.title = element_text(size = 10)) 
``` 

```{r obtain data on the position of labels, include = FALSE}
state_centroids <- centroid_labels(regions = c("states"))
# Remove Washington D.C.
state_centroids <- state_centroids[- which(state_centroids$abbr == "DC"),]
```

```{r manually adjust label positions, include = FALSE}
state_centroids_adj <- state_centroids

# Adjust label position for Rhode Island
state_centroids_adj[which(state_centroids_adj$abbr == "RI"),]$x <- 
  state_centroids_adj[which(state_centroids_adj$abbr == "RI"),]$x + 75000
state_centroids_adj[which(state_centroids_adj$abbr == "RI"),]$y <- 
  state_centroids_adj[which(state_centroids_adj$abbr == "RI"),]$y - 75000

# Adjust label position for New Jersey
state_centroids_adj[which(state_centroids_adj$abbr == "NJ"),]$x <- 
  state_centroids_adj[which(state_centroids_adj$abbr == "NJ"),]$x + 120000

# Adjust label position for Delaware
state_centroids_adj[which(state_centroids_adj$abbr == "DE"),]$x <- 
  state_centroids_adj[which(state_centroids_adj$abbr == "DE"),]$x + 120000
```

```{r make layer for labels of states, include = FALSE}
state_label <- geom_text(data = state_centroids_adj, 
                         aes(x = x, y = y, label = abbr),
                         color = "black", size = 3)
```

```{r 2018 vote share margin map with labels, echo = FALSE}
plot_vote_share_margin_2018 + state_label
```

## Vote Share Margin: 2014

### Vote Share Margin by State
```{r 2014 two-party vote share margin by state, include = FALSE}
vote_share_2014 <- vote_share %>%
  filter(raceYear == 2014) %>%
  group_by(State) %>%
  summarize(total_R = sum(RepVotes), total_D = sum(DemVotes)) %>%

  # Calculate vote share in each state
  mutate(vote_share_R = 100 * total_R / (total_R + total_D),
         vote_share_D = 100 * total_D / (total_R + total_D)) %>%
  
  # Calculate vote share margin (percent)
  mutate(margin_R = vote_share_R - vote_share_D)  %>%
  
  # State -> state
  rename(state = State)
```

```{r 2014 vote share margin map, echo = FALSE}
plot_vote_share_margin_2014 <- 
  plot_usmap(data = vote_share_2014, regions = "states", values = "margin_R") +
  
  # Change color based on vote share margin
  scale_fill_gradient2(
    high = "red",
    mid = "white",
    low = "blue",
    name = "Vote Share \nMargin (%)") +
  
  labs(title = "Vote Share Margin by State",
       subtitle = "2014 House of Representatives Elections") +
  
  # set theme  
  theme(legend.position = "right",
        plot.title = element_text(size = 12),
        plot.subtitle = element_text(size = 10),
        legend.title = element_text(size = 10)) 
``` 

```{r 2014 vote share margin map with labels, echo = FALSE}
plot_vote_share_margin_2014 + state_label
```

### Vote Share Margin by Congressional District
```{r download shapefile for 114th Congress (2014 election), eval = FALSE, include = FALSE}
cd114 <- get_congress_map(114) 
```

```{r edit shapefile, include = FALSE}
cd114 <- readRDS("analysis_data/districts114.rds") %>%
  
  # Select columns, rename, and convert district number to numeric
  select(STATENAME, DISTRICT) %>%
  rename(district_num = DISTRICT, State = STATENAME) %>%
  mutate(district_num = as.numeric(district_num))
```

```{r 2014 two-party vote share margin by CD, include = FALSE}
vote_share_2014_cd <- vote_share %>%
  
  # Filter out 2014 data
  filter(raceYear == 2014) %>%
  select(State, district_num, RepVotesMajorPercent, DemVotesMajorPercent) %>%
  
  # Calculate vote share margin
  mutate(margin_R = RepVotesMajorPercent - DemVotesMajorPercent)
```

```{r merge shapefile with election results data, include = FALSE}
cd114_vote_share <- cd114 %>% left_join(vote_share_2014_cd, # Merge together with shapefile
                                        by = c("State", "district_num"))
```

```{r clean cd114_vote_share, include = FALSE}
cd114_vote_share <- cd114_vote_share %>%
  ms_simplify() %>% # Simplify geometry
  shift_geometry(position = "outside") # Move Alaska and Hawaii
```

```{r vote margin by CD in 2014, echo = FALSE, message = FALSE, warning = FALSE}
ggplot(data = cd114_vote_share) +
  
  # Plot vote margin (Republican two-party vote share - Democrat vote share)
  geom_sf(aes(fill = margin_R), color = "grey80", size = 0.05) +
  scale_fill_gradient2(
    high = "red",
    mid = "white",
    low = "blue",
    name = "Vote Share \nMargin (%)") +

 labs(title = "Vote Share Margin by Congressional District",
      subtitle = "2014 House of Representatives Elections",
      caption = "Shapefile was obatined from Lewis et al. (2020)") +
  
 # Set theme
 theme(axis.line = element_blank(), axis.text = element_blank(),
       axis.ticks = element_blank(), axis.title = element_blank(),
       panel.background = element_blank())
```

### Example: North Carolina
```{r extract data for 2014 NC, include = FALSE}
cd114_nc_vote_share <- cd114_vote_share %>%
  filter(State %in% "North Carolina") %>%
  mutate(centroid = st_centroid(geometry))
```

```{r North Carolina cities, include = FALSE}
nc_cities <- data.frame(longitude = c(-80.842447, -78.638797, -79.788381,
                                      -78.900964), 
                        latitude = c(35.219930, 35.786045, 36.073405,
                                     36.000958),
                        names = c("Charlotte", "Raleigh", "Greensboro",
                                  "Durham"))

nc_cities <- sf::st_as_sf(nc_cities, coords = c("longitude", "latitude"), 
                          crs = 4269) # CRS: NAD83
```

```{r 2014 North Carolina vote margin, echo = FALSE, message = FALSE, warning = FALSE}
ggplot(data = cd114_nc_vote_share) +
  
  # Plot vote margin (Republican two-party vote share - Democrat vote share)
  geom_sf(aes(fill = margin_R), color = "grey80") +
  scale_fill_gradient2(
    high = "red",
    mid = "white",
    low = "blue",
    name = "Vote Share \nMargin (%)") +

 # Label district numbers 
 geom_sf_text(aes(label = district_num, geometry = centroid), color = "black") +
  
 # Plot cities  
 geom_sf(data = nc_cities, size = 2, shape = 21, fill = "red") +
 geom_sf_text(data = nc_cities, aes(label = names), 
              color = "black", size = 3,
              # adjust the position of the labels
              # "Charlotte", "Raleigh", "Greensboro", "Durham"
              nudge_x = c(0, 20000, 0, 0),
              nudge_y = c(-10000, 20000, -20000, 20000)) +
  
 labs(title = "Vote Share Margin by Congressional District",
      subtitle = "2014 House of Representatives Elections in North Carolina",
      caption = "Shapefile was obatined from Lewis et al. (2020)") +
  
 # Set theme
 theme(axis.line = element_blank(), axis.text = element_blank(),
       axis.ticks = element_blank(), axis.title = element_blank(),
       panel.background = element_blank())
```

## Vote Share vs Seat Share: 2014
```{r 2014 vote share by State, include = FALSE}
plot_vote_share_2014 <- 
  plot_usmap(data = vote_share_2014, regions = "states", values = "vote_share_R") +
  
  # Change color based on vote share margin
  scale_fill_gradient2(
    high = "red",
    mid = "white",
    low = "blue",
    midpoint = 50,
    name = "Share(%)") +
  
  # Set theme  
  theme(legend.position = "right",
        legend.title = element_text(size = 10)) 
``` 

```{r read 2014 seat share data, include = FALSE}
seat_share_2014 <- read_csv("analysis_data/house_2014_summary.csv", 
                        skip = 2)
seat_share_2014 <- head(seat_share_2014, 51) # ignore unnecessary lines
```

```{r clean 2014 seat share data, include = FALSE}
seat_share_2014 <- seat_share_2014 %>%
  select(Area, RepWinner, DemWinner) %>%
  # Convert to numeric
  mutate(RepWinner = as.numeric(RepWinner),
         DemWinner = as.numeric(DemWinner)) %>%

  # Add up number of seats
  group_by(Area) %>%
  summarize(RepWinner = sum(RepWinner), 
            DemWinner = sum(DemWinner)) %>%

# Calculate seat share
  mutate(seat_share_R = 100 * (RepWinner / (RepWinner + DemWinner))) %>%
  rename(state = Area)  # Rename column
```

```{r Republican seat share by state, echo = FALSE}
plot_seat_share_2014 <- 
  plot_usmap(data = seat_share_2014, regions = "states", values = "seat_share_R") +
  
  # Change color based on seat share
  scale_fill_gradient2(low = "blue", 
                       mid = "white", 
                       high = "red", 
                       midpoint = 50,
                       name = "Share (%)") +
  # Set theme  
  theme(legend.position = "right",
        legend.title = element_text(size = 10)) 
```



```{r plot showing difference between seat share and vote share (with labels), echo = FALSE}
subplot(plot_vote_share_2014,
        plot_seat_share_2014) %>%
  layout(title = "Republican Vote Share vs Seat Share:\n2014 House of Representatives Election",
         annotations = 
           list(list(x = 0.2,  y = 0.8,  text = "Vote Share",  
                     xref = "paper",  yref = "paper",  
                     xanchor = "center",  yanchor = "bottom",  
                     showarrow = FALSE),
                list(x = 0.8,  y = 0.8,  text = "Seat Share",  
                     xref = "paper",  yref = "paper",  
                     xanchor = "center",  yanchor = "bottom",  
                     showarrow = FALSE),
                list(x = 0.8,  y = 0.2,  
                     text = "Seat share data was obtained from CQ Voting and Elections Collection",  
                     xref = "paper",  yref = "paper",  
                     xanchor = "center",  yanchor = "bottom",  
                     showarrow = FALSE)
                ))
```


```{r merge seat share data with vote share data, include = FALSE}
share_2014 <- left_join(vote_share_2014, seat_share_2014, by = "state") %>%
  # calculate difference between vote share and seat share
  mutate(diff_R = seat_share_R - vote_share_R)
```

```{r winning majority of seats without winning popular vote: R, eval = FALSE}
share_2014 %>%
  filter(vote_share_R < 50 & seat_share_R > 50)
```

```{r winning majority of seats without winning popular vote: D, eval = FALSE}
share_2014 %>%
  filter(vote_share_R > 50 & seat_share_R < 50)
```

In `r sum(share_2014$diff_R > 0)` states, Republicans gained a higher seat share relative to their vote share.



## References

## Data Sources
Jeffrey B. Lewis, Brandon DeVine, Lincoln Pitcher, and Kenneth C. Martis. (2020). *Digital Boundary Definitions of United States Congressional Districts* (Version 1.5) [Data file]. https://cdmaps.polisci.ucla.edu.

House general elections, All States, 2014 summary. (2022). *CQ voting and elections collection (web site)*. http://library.cqpress.com.ezp-prod1.hul.harvard.edu/elections/avg2014-3us1