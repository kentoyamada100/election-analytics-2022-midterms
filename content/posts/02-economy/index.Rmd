---
title: "02-Economy"
author: "Kento Yamada"
date: '2022-09-19'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/Users/kentoyamada/Documents/R-Projects/election-analytics-2022-midterms')
```

```{r load packages, include = FALSE}
library(tidyverse)
library(stargazer)
library(kableExtra)
library(ggforce)
library(gt)
```

```{r load data, include = FALSE}
# Data on GDP/quarter
gdp_df <- read_csv("analysis_data/GDP_quarterly.csv") %>%
  select(-c("...1", "...2")) # de-select unnecessary columns

# Data on RDI/quarter
rdi_df <- read_csv("analysis_data/RDI_quarterly.csv") %>%
  select(-"...1") # de-select unnecessary column

# Data on unemployment
unemp_df <- read_csv("analysis_data/unemployment_national_quarterly_final.csv") %>%
  select(-c("...1", "...2")) # de-select unnecessary columns

# Data on vote/seat share
share_df <- read_csv("analysis_data/house_popvote_seats.csv") %>%
  select(-c("...1", "AreaAll")) # de-select unnecessary columns
```

```{r clean gdp_df, include = FALSE}
# Select relevant columns
gdp_df_relevant <- gdp_df %>%
  select(year, quarter_cycle, GDPC1)

# Filter out data for Q1
gdp_df_q1 <- gdp_df_relevant %>%
  filter(quarter_cycle == 1) %>%
  # Note that election years are one year after Q1
  mutate(election_year = year + 1) %>% 
  rename(gdp_q1 = GDPC1) %>%
  select(-c(quarter_cycle, year))

# Filter out data for Q6
gdp_df_q6 <- gdp_df_relevant %>%
  filter(quarter_cycle == 6) %>%
  select(-quarter_cycle) %>%
  rename(gdp_q6 = GDPC1, election_year = year)

# Filter out data for Q7
gdp_df_q7 <- gdp_df_relevant %>%
  filter(quarter_cycle == 7) %>%
  select(-quarter_cycle) %>%
  rename(gdp_q7 = GDPC1, election_year = year)

# Merge and finalize data
gdp_df_final <- left_join(gdp_df_q7, gdp_df_q6, by = "election_year") %>%
  left_join(gdp_df_q1, by = "election_year") %>%
  mutate(gdp_q7_q6 = (gdp_q7 - gdp_q6) / gdp_q6 * 100,
         gdp_q7_q1 = (gdp_q7 - gdp_q1) / gdp_q1 * 100) %>%
  select(-c(gdp_q7, gdp_q6, gdp_q1))
```

```{r clean rdi_df, include = FALSE}
# Select relevant columns
rdi_df_relevant <- rdi_df %>%
  select(year, quarter_cycle, DSPIC_qt)

# Filter out data for Q1
rdi_df_q1 <- rdi_df_relevant %>%
  filter(quarter_cycle == 1) %>%
  # Note that election years are one year after Q1
  mutate(election_year = year + 1) %>% 
  rename(rdi_q1 = DSPIC_qt) %>%
  select(-c(quarter_cycle, year))

# Filter out data for Q6
rdi_df_q6 <- rdi_df_relevant %>%
  filter(quarter_cycle == 6) %>%
  select(-quarter_cycle) %>%
  rename(rdi_q6 = DSPIC_qt, election_year = year)

# Filter out data for Q7
rdi_df_q7 <- rdi_df_relevant %>%
  filter(quarter_cycle == 7) %>%
  select(-quarter_cycle) %>%
  rename(rdi_q7 = DSPIC_qt, election_year = year)

# Merge and finalize data
rdi_df_final <- left_join(rdi_df_q7, rdi_df_q6, by = "election_year") %>%
  left_join(rdi_df_q1, by = "election_year") %>%
  mutate(rdi_q7_q6 = (rdi_q7 - rdi_q6) / rdi_q6 * 100,
         rdi_q7_q1 = (rdi_q7 - rdi_q1) / rdi_q1 * 100) %>%
  select(-c(rdi_q7, rdi_q6, rdi_q1))
```

```{r clean unemp_df, include = FALSE}
# Select relevant columns
unemp_df_relevant <- unemp_df %>%
  select(year, quarter_cycle, UNRATE) %>%
  rename(unrate = UNRATE) %>%
  # Fix quarterly cycle 
  mutate(quarter_cycle = case_when(
    quarter_cycle == 1 ~ 5,
    quarter_cycle == 2 ~ 6,
    quarter_cycle == 3 ~ 7,
    quarter_cycle == 4 ~ 8,
    quarter_cycle == 5 ~ 1,
    quarter_cycle == 6 ~ 2,
    quarter_cycle == 7 ~ 3,
    quarter_cycle == 8 ~ 4
  ))

# Filter out data for Q1
unemp_df_q1 <- unemp_df_relevant %>%
  filter(quarter_cycle == 1) %>%
  # Note that election years are one year after Q1
  mutate(election_year = year + 1) %>%
  select(-c(quarter_cycle, year)) %>%
  rename(unrate_q1 = unrate)

# Filter out data for Q6
unemp_df_q6 <- unemp_df_relevant %>%
  filter(quarter_cycle == 6) %>%
  select(-quarter_cycle) %>%
  rename(election_year = year) %>%
  rename(unrate_q6 = unrate)

# Filter out data for Q7
unemp_df_q7 <- unemp_df_relevant %>%
  filter(quarter_cycle == 7) %>%
  select(-quarter_cycle) %>%
  rename(election_year = year) %>%
  rename(unrate_q7 = unrate)

# Merge and finalize data
unemp_df_final <- left_join(unemp_df_q7, unemp_df_q6, by = "election_year") %>%
  left_join(unemp_df_q1, by = "election_year") 
```

```{r clean share_df, include = FALSE}
# Define incumbent President's party affiliation
share_df_final <- share_df
# In a Presidential election year, share_df$president_party shows the party 
# of the candidate who won the Presidential election.
# Thus, in cases where the party that the incumbent President belongs to
# loses the Presidential election,
# share_df$president_party is different from the incumbent President's party
share_df_final$inc_pres_party <- share_df$president_party
share_df_final$inc_pres_party[which(share_df_final$year == 1952)] <- "D"
share_df_final$inc_pres_party[which(share_df_final$year == 1960)] <- "R"
share_df_final$inc_pres_party[which(share_df_final$year == 1968)] <- "D"
share_df_final$inc_pres_party[which(share_df_final$year == 1976)] <- "R"
share_df_final$inc_pres_party[which(share_df_final$year == 1980)] <- "D"
share_df_final$inc_pres_party[which(share_df_final$year == 1992)] <- "R"
share_df_final$inc_pres_party[which(share_df_final$year == 2000)] <- "D"
share_df_final$inc_pres_party[which(share_df_final$year == 2008)] <- "R"
share_df_final$inc_pres_party[which(share_df_final$year == 2016)] <- "D"
share_df_final$inc_pres_party[which(share_df_final$year == 2020)] <- "R"

share_df_final <- share_df_final %>%
  mutate(pp_vote_share = # Two-party vote share of the incumbent President's party
           case_when(inc_pres_party == "D" ~ D_majorvote_pct,
                     inc_pres_party == "R" ~ R_majorvote_pct),
         midterm = # Midterm election or not
           case_when(year %% 4 == 0 ~ FALSE,
                     year %% 4 == 2 ~ TRUE),
         pp_seat_share = # Seat share of the incumbent President's party
           case_when(inc_pres_party == "D" ~ D_seats/435,
                     inc_pres_party == "R" ~ R_seats/435)) %>%
  select(year, pp_vote_share, midterm, pp_seat_share, inc_pres_party, president_party) %>%
  rename(election_year = year)
```

```{r finalize df, include = FALSE}
df <- full_join(gdp_df_final, rdi_df_final, by = "election_year") %>%
  full_join(unemp_df_final, by = "election_year") %>%
  full_join(share_df_final, by = "election_year")
```

## Economic Voting


```{r model 1, include = FALSE}
model1 <- lm(pp_vote_share ~ rdi_q7_q6, data = df)
```
```{r model 2, include = FALSE}
model2 <- lm(pp_vote_share ~ rdi_q7_q6 + midterm, data = df)
```
```{r model 3, include = FALSE}
model3 <- lm(pp_vote_share ~ gdp_q7_q6, data = df)
```
```{r model 4, include = FALSE}
model4 <- lm(pp_vote_share ~ gdp_q7_q6 + midterm, data = df)
```
```{r model 5, include = FALSE}
model5 <- lm(pp_vote_share ~ rdi_q7_q6 + gdp_q7_q6 + midterm, data = df)
```
```{r model 6, include = FALSE}
model6 <- lm(pp_vote_share ~ rdi_q7_q6 + gdp_q7_q6 + midterm + unrate_q7, data = df)
```

```{r regression output 1, include = FALSE}
stargazer(model1, model2, model3, model4, model5, model6,
          type = 'html',
          title = "Table 1: Models of Economic Voting Based on 1948-2020 Data",
          dep.var.labels = "President's Party's Vote Share",
          covariate.labels = 
            c('RDI Q6-Q7', 'Midterm', 'Unemployment Q7', 'GDP Q6-Q7'),
          notes = "Data on RDI was unavailable for 1948-1958 elections.",
          column.sep.width = "5pt") %>%
  as_image(file = "static/posts/02-economy/table1.png")
```

```{r include table, include = FALSE}
blogdown::build_dir("static")
```

![](table1.png)


#### What's wrong with these models?: Multicollinearity
```{r correlation test, include = FALSE}
cor.coef <- cor(df$gdp_q7_q6[!is.na(df$rdi_q7_q6)], 
                df$rdi_q7_q6[!is.na(df$rdi_q7_q6)])
cor.test.results <- cor.test(df$gdp_q7_q6, df$rdi_q7_q6)
```


```{r df_2020, include = FALSE}
# Discard 2020
df_without_2020 <- df[df$election_year != 2020,]
```

```{r correlation test 2, include = FALSE}
cor.coef.2 <- cor(df_without_2020$gdp_q7_q6[!is.na(df_without_2020$rdi_q7_q6)], 
                df_without_2020$rdi_q7_q6[!is.na(df_without_2020$rdi_q7_q6)])
cor.test.results.2 <- cor.test(df_without_2020$gdp_q7_q6, 
                               df_without_2020$rdi_q7_q6)
```

`r round(cor.coef, 2) ` and ($p = $`r format(cor.test.results$p.value, 2, scientific = TRUE, digits = 2)`)


`r round(cor.coef.2, 2) `  ($p = $`r format(cor.test.results.2$p.value, 2, scientific = TRUE, digits = 2)`)


#### What's wrong with these models?: Outlier

```{r outlier, echo = FALSE, message = FALSE, warning = FALSE}
ggplot(data = df, aes(x = df$gdp_q7_q6, y = df$rdi_q7_q6)) +
  geom_point() +
  theme_classic() +
  labs(title = "Figure 1: GDP Growth vs RDI Growth: Q7-Q8",
       x = "Percent Change in GDP",
       y = "Percent Change in RDI") +
  geom_circle(aes(x0 = 0, y0 = 0, r = 3), inherit.aes = FALSE,
              color = "blue")+
  annotate(geom = "text",
           x = 22, y = -4, label = "2020", color = "red") +
  theme(plot.title = element_text(hjust = 0.5))
```



## Predictive Models
```{r modelA, include = FALSE}
modelA <- lm(pp_vote_share ~ rdi_q7_q6 + midterm, data = df_without_2020)
```
```{r modelB, include = FALSE}
modelB <- lm(pp_vote_share ~ gdp_q7_q6 + midterm, data = df_without_2020)
```
```{r modelC, include = FALSE}
modelC <- lm(pp_vote_share ~ gdp_q7_q6 + midterm + unrate_q7, data = df_without_2020)
```
```{r modelD, include = FALSE}
modelD <-  lm(pp_vote_share ~ gdp_q7_q1 + midterm + unrate_q7, data = df_without_2020)
```


```{r regression output 2, include = FALSE}
stargazer(modelA, modelB, modelC, modelD,
          type = 'html',
          title = "Table 2: Models of Economic Voting Based on 1948-2018 Data",
          dep.var.labels   = "President's Party's Vote Share",
          covariate.labels = c('RDI Q6-Q7', 'GDP Q6-Q7', "GDP Q1-Q7", "Midterm",
                               'Unemployment Q7'),
          column.labels = c("(A)", "(B)", "(C)", "(D)"),
          model.numbers = FALSE,
          notes = "Data on RDI was unavailable for 1948-1958 elections.") %>%
  as_image(file = "static/posts/02-economy/table2.png")
```

![](table2.png)
```{r model Cd, include = FALSE}
modelCd <- lm(pp_vote_share ~ gdp_q7_q6 + midterm + unrate_q7, 
               data = df_without_2020 %>% filter(inc_pres_party == "D"))
```
```{r model 8.r, include = FALSE}
modelCr <- lm(pp_vote_share ~ gdp_q7_q6 + midterm + unrate_q7, 
               data = df_without_2020 %>% filter(inc_pres_party == "R"))
```


## Model Testing and Predictions

```{r plot residuals, echo = FALSE}
plot(df$election_year, df$pp_vote_share,
     type = "l",
     main = "Figure 2: Actual Values vs Predicted Values",
     xlab = "Year", ylab = "President's Party's Vote Share")

# Predicted values based on Model A
# Note that for Model A, data for 1948-1958 elections is missing
lines(df_without_2020$election_year[-(1:6)], 
       predict(modelA, df_without_2020)[-(1:6)], col = "red", lty = "dotted") 

# Predicted values based on Model B
lines(df_without_2020$election_year,
       predict(modelB, df_without_2020), col = "blue", lty = "dotted")

# Predicted values based on Model C
lines(df_without_2020$election_year,
       predict(modelC, df_without_2020), col = "yellow") 

# Predicted values based on Model D
lines(df_without_2020$election_year, #De-select 2020
       predict(modelD, df_without_2020), col = "lightgreen") 

# Add legend
legend(2008, 57, legend=c("Model A", "Model B", "Model C", "Model D"),
       col=c("red", "blue", "yellow", "lightgreen"), 
       lty= c(3, 3, 1, 1), cex = 0.7)
```

```{r RMSE, include = FALSE}
# Square prediction errors, take mean, then take square root
rmse_modelA <- (modelA$model$pp_vote_share - modelA$fitted.values)^2 %>%
  mean() %>% sqrt()
rmse_modelB <- (modelB$model$pp_vote_share - modelB$fitted.values)^2 %>%
  mean() %>% sqrt()
rmse_modelC <- (modelC$model$pp_vote_share - modelC$fitted.values)^2 %>%
  mean() %>% sqrt()
rmse_modelD <- (modelD$model$pp_vote_share - modelD$fitted.values)^2 %>%
  mean() %>% sqrt()
```

```{r out-of-sample modelA, include = FALSE}
os_modelA <- lm(pp_vote_share ~ rdi_q7_q6 + midterm, 
                # Leave 2018 out of the model
                data = df_without_2020[df_without_2020$election_year != 2018,])

os_modelA_pred <-
  # Predict 2018 outcomes
  predict(os_modelA, df_without_2020[df_without_2020$election_year == 2018,])

# Calculate difference between predicted value and true value
os_modelA_true <- df_without_2020$pp_vote_share[df_without_2020$election_year == 2018]
os_modelA_error <- os_modelA_pred - os_modelA_true
```

```{r out-of-sample modelB, include = FALSE}
os_modelB <- lm(pp_vote_share ~ gdp_q7_q6  + midterm, 
                # Leave 2018 out of the model
                data = df_without_2020[df_without_2020$election_year != 2018,])

os_modelB_pred <- 
  # Predict 2018 outcomes
  predict(os_modelB, df_without_2020[df_without_2020$election_year == 2018,])

# Calculate difference between predicted value and true value
os_modelB_true <- df_without_2020$pp_vote_share[df_without_2020$election_year == 2018]
os_modelB_error <- os_modelB_pred - os_modelB_true
```

```{r out-of-sample modelC, include = FALSE}
os_modelC <- lm(pp_vote_share ~ gdp_q7_q6 + midterm + unrate_q7,
                # Leave 2018 out of the model
                data = df_without_2020[df_without_2020$election_year != 2018,])
os_modelC_pred <- 
  # Predict 2018 outcomes
  predict(os_modelC, df_without_2020[df_without_2020$election_year == 2018,])

# Calculate difference between predicted value and true value
os_modelC_true <- df_without_2020$pp_vote_share[df_without_2020$election_year == 2018]
os_modelC_error <- os_modelC_pred - os_modelC_true
```

```{r out-of-sample modelD, include = FALSE}
os_modelD <- lm(pp_vote_share ~ gdp_q7_q1 + midterm + unrate_q7,
                # Leave 2018 out of the model
                 data = df_without_2020[df_without_2020$election_year != 2018,])
os_modelD_pred <- 
  # Predict 2018 outcomes
  predict(os_modelD, df_without_2020[df_without_2020$election_year == 2018,])

# Calculate difference between predicted value and true value
os_modelD_true <- df_without_2020$pp_vote_share[df_without_2020$election_year == 2018]
os_modelD_error <- os_modelD_pred - os_modelD_true
```

```{r cross validation Model A, include = FALSE}
cv_modelA_error <- 
  sapply(1:1000, function(i){
    # Randomly hold out 8 observations
    years_outsamp <- sample(df_without_2020$election_year[-(1:6)], 8) 
      #De-select years with missing values
    
    # Run linear regression based on the remaining observations
    outsamp_mod <- lm(pp_vote_share ~ rdi_q7_q6 + midterm,
                    df_without_2020[!(df_without_2020$election_year %in% years_outsamp),])
    
    # Make predictions based on the model
    outsamp_pred <- predict(outsamp_mod,
                          df_without_2020[df_without_2020$election_year %in% years_outsamp,])
    
    # True values
    outsamp_true <- df_without_2020$pp_vote_share[df_without_2020$election_year 
                                                       %in% years_outsamp]
    
    mean(outsamp_pred - outsamp_true)
})
```

```{r cross validation Model B, include = FALSE}
cv_modelB_error <- 
  sapply(1:1000, function(i){
    # Randomly hold out 8 observations
    years_outsamp <- sample(df_without_2020$election_year, 8) 
    
    # Run linear regression based on the remaining observations
    outsamp_mod <- lm(pp_vote_share ~ gdp_q7_q6 + midterm,
                    df_without_2020[!(df_without_2020$election_year %in% years_outsamp),])
    
    # Make predictions based on the model
    outsamp_pred <- predict(outsamp_mod,
                          df_without_2020[df_without_2020$election_year %in% years_outsamp,])
    
    # True values
    outsamp_true <- df_without_2020$pp_vote_share[df_without_2020$election_year 
                                                       %in% years_outsamp]
    
    mean(outsamp_pred - outsamp_true)
})
```

```{r cross validation Model C, include = FALSE}
cv_modelC_error <- 
  sapply(1:1000, function(i){
    # Randomly hold out 8 observations
    years_outsamp <- sample(df_without_2020$election_year, 8) 
    
    # Run linear regression based on the remaining observations
    outsamp_mod <- lm(pp_vote_share ~ gdp_q7_q6 + midterm + unrate_q7,
                    df_without_2020[!(df_without_2020$election_year %in% years_outsamp),])
    
    # Make predictions based on the model
    outsamp_pred <- predict(outsamp_mod,
                          df_without_2020[df_without_2020$election_year %in% years_outsamp,])
    
    # True values
    outsamp_true <- df_without_2020$pp_vote_share[df_without_2020$election_year 
                                                       %in% years_outsamp]
    
    mean(outsamp_pred - outsamp_true)
})
```

```{r cross validation Model D, include = FALSE}
cv_modelD_error <- 
  sapply(1:1000, function(i){
    # Randomly hold out 8 observations
    years_outsamp <- sample(df_without_2020$election_year, 8) 
    
    # Run linear regression based on the remaining observations
    outsamp_mod <- lm(pp_vote_share ~ gdp_q7_q1 + midterm + unrate_q7,
                    df_without_2020[!(df_without_2020$election_year %in% years_outsamp),])
    
    # Make predictions based on the model
    outsamp_pred <- predict(outsamp_mod,
                          df_without_2020[df_without_2020$election_year %in% years_outsamp,])
    
    # True values
    outsamp_true <- df_without_2020$pp_vote_share[df_without_2020$election_year 
                                                       %in% years_outsamp]
    
    mean(outsamp_pred - outsamp_true)
})
```

```{r mean out-of-sample residual plot, include = FALSE}
histograms <- list(
  hist(cv_modelA_error, xlab = "", main = ""),
  hist(cv_modelB_error, xlab = "", main = ""),
  hist(cv_modelC_error, xlab = "", main = ""),
  hist(cv_modelD_error, xlab = "", main = "")
)
```

```{r predictions, include = FALSE}
# Get data for 2022
latest_data <- 
  data.frame(midterm = TRUE, 
             rdi_q7_q6 = 
               # Data for Q7 is not available yet -> Calculate Q6-Q5
               # RDI in the Q2 of 2022 (i.e. Q6)
               (rdi_df_relevant$DSPIC_qt[rdi_df_relevant$year == 2022][2] -
               # RDI in the Q1 of 2022 (i.e. Q5)
               rdi_df_relevant$DSPIC_qt[rdi_df_relevant$year == 2022][1])/
               rdi_df_relevant$DSPIC_qt[rdi_df_relevant$year == 2022][1],
             gdp_q7_q6 =
               # Data for Q7 is not available yet -> Calculate Q6-Q5
               # GDP in the Q2 of 2022 (i.e. Q6)
               (gdp_df_relevant$GDPC1[gdp_df_relevant$year == 2022][2] -
               # GDP in the Q1 of 2022 (i.e. Q5)
               gdp_df_relevant$GDPC1[gdp_df_relevant$year == 2022][1])/
               gdp_df_relevant$GDPC1[gdp_df_relevant$year == 2022][1],
             gdp_q7_q1 =
               # Data for Q7 is not available yet -> Calculate Q6-Q1
               # GDP in the Q2 of 2022 (i.e. Q6)
               (gdp_df_relevant$GDPC1[gdp_df_relevant$year == 2022][2] -
               # GDP in the Q1 of 2021 (i.e. Q5)
               gdp_df_relevant$GDPC1[gdp_df_relevant$year == 2021][1])/
               gdp_df_relevant$GDPC1[gdp_df_relevant$year == 2021][1],
             unrate_q7 =
               # Data for Q7 is not available yet -> Use Q6 data
               unemp_df_relevant$unrate[unemp_df_relevant$year == 2022][2])
```

```{r make predictions, include = FALSE}
modelA_pred <- predict(modelA, latest_data, interval = "prediction")
modelB_pred <- predict(modelB, latest_data, interval = "prediction")
modelC_pred <- predict(modelC, latest_data, interval = "prediction")
modelD_pred <- predict(modelD, latest_data, interval = "prediction")
```


```{r model evaluation, include = FALSE}
model_eval <- as.data.frame(
  matrix(
    c(
    "A", summary(modelA)$r.squared, rmse_modelA, os_modelA_error, 
     histograms[1], modelA_pred,
    "B", summary(modelB)$r.squared, rmse_modelB, os_modelB_error,
     histograms[2], modelB_pred,
    "C", summary(modelC)$r.squared, rmse_modelC, os_modelC_error,
     histograms[3], modelC_pred,
    "D", summary(modelD)$r.squared, rmse_modelD, os_modelD_error,
    histograms[4], modelD_pred
    ),
    ncol = 8, byrow = TRUE))
# Label columns
names(model_eval) <- c("Model", "R-squared", "RMSE", 
                       "Leave-One-Out", "Cross Validation",
                       "Fitted", "Lower", "Upper")
# Convert to numeric
model_eval[,2] <- as.numeric(model_eval[,2])
model_eval[,3] <- as.numeric(model_eval[,3])
model_eval[,4] <- as.numeric(model_eval[,4])
```
```{r format table 3, echo = FALSE}
gt(model_eval) %>%
  tab_header(title = "Table 3: Model Testing and Prediction for 2022") %>%
  fmt_number(columns = 2:3, decimals = 2) %>%
  tab_spanner(
    label = "Model Evaluation",
    columns = 2:5
  ) %>%   
  tab_spanner(
    label = "Predictions",
    columns = 6:8
  ) %>%
  text_transform(
    locations = cells_body(columns = 5),
    fn = function(x) {
      map(histograms, plot)
    }
  )
```

```{r}
model_eval
```


### Predictions


## References


